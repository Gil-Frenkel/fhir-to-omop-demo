# Introduction
This directory is where I load terminology into an empty OMOPCDM database, which I generate using a script: `/data/omopcdm/ddl/5.4/sqlite_extended/update-ddl.sh`.

## Athena
You have to request terminology data sets from Athena before you can load any real data into the CDM.

TODO: document that process.

Once you have downloaded terminology sets from the Athena website, you can unzip them and place the provided `*.csv` files here.

NOTE: if you have requested CPT4 codes, you will have to sign up for an API key and run the provided `cpt.sh` script to download them using their provided tool.  The download takes 2 - 3 hours to complete, so give yourself time!

```sh
# From this directory:
cp ~/Downloads/vocabulary_download_v5_*/*.csv .
```

## Setup
You can then run the `load.sh` script and it will create a new empty DB for you by first transforming the OMOPCDM DDL files into a schema that sqlite can read, then using that to create an empty database.

The empty database will be copied here, and the script will then load the csv data into it.

The script takes between 3 and 6 minutes to complete on my laptop.

### Example output

```
(base) carl@home athena % time ./load.sh
Creating an initial ${DB} file from DDL...
Adding PRIMARY KEYS to DDL
Adding FOREIGN KEYS to DDL
Creating empty cdm.db database
DONE!

Truncating Athena tables in cdm.db!
LOADING: domain
 - Dropping indexes on domain...
 - Importing 51 rows from DOMAIN.csv...
 - Restoring indexes on domain...
LOADING: vocabulary
 - Dropping indexes on vocabulary...
 - Importing 70 rows from VOCABULARY.csv...
 - Restoring indexes on vocabulary...
LOADING: concept_class
 - Dropping indexes on concept_class...
 - Importing 424 rows from CONCEPT_CLASS.csv...
 - Restoring indexes on concept_class...
LOADING: relationship
 - Dropping indexes on relationship...
 - Importing 697 rows from RELATIONSHIP.csv...
 - Restoring indexes on relationship...
...skipping CONCEPT_CPT4.csv
LOADING: drug_strength
 - Dropping indexes on drug_strength...
 - Importing 2981808 rows from DRUG_STRENGTH.csv...
 - Restoring indexes on drug_strength...
 - Nulling empty drug_strength.amount_unit_concept_id values...
 - Nulling empty drug_strength.numerator_unit_concept_id values...
 - Nulling empty drug_strength.denominator_unit_concept_id values...
LOADING: concept_synonym
 - Dropping indexes on concept_synonym...
 - Importing 2592890 rows from CONCEPT_SYNONYM.csv...
 - Restoring indexes on concept_synonym...
...skipping backup.CONCEPT.csv
LOADING: concept
 - Dropping indexes on concept...
 - Importing 6432565 rows from CONCEPT.csv...
 - Restoring indexes on concept...
LOADING: concept_ancestor
 - Dropping indexes on concept_ancestor...
 - Importing 73065004 rows from CONCEPT_ANCESTOR.csv...
 - Restoring indexes on concept_ancestor...
LOADING: concept_relationship
 - Dropping indexes on concept_relationship...
 - Importing 39556731 rows from CONCEPT_RELATIONSHIP.csv...
 - Restoring indexes on concept_relationship...
DEBUG: running foreign_key_check on cdm.db...

Press Ctrl-C to abort at any time.
COMPLETED: 362 seconds
./load.sh  260.69s user 98.95s system 98% cpu 6:05.20 total
```
